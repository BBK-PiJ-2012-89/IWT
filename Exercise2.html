<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Exercise 2</title> 
<style type="text/css">
h2 {
	text-align:center;
	font-family: Arial;
	text-decoration:underline;
	color:grey;
}
body{
	color:#6699CC;
	font-family:"MS Serif", "New York", serif;
	background-color:#FFFFF3;
}
#tableArea{
	text-align:center;
	color: #F9C
	background-color:#999;
}
#elementArea{
	table-layout:auto;
	text-align:center;
	font-size:24px;
	text-decoration:underline;

}
</style>
<script type="text/javascript">
	
	function loadXML(url) {
		
	  if(window.XMLHttpRequest)
	  	{
		xhr=new XMLHttpRequest();
		} 
	else //internet explorer
		{
		xhr=new ActiveXObject("Microsoft.XMLHTTP");
		}
	  xhr.open("GET",url,false);
	  xhr.send("");
	  return xhr.responseXML;
	}
	
	function getThirdLevel(){
		
		var getTheFile = document.getElementById("thirdFile").value;	
		var xmlDoc = loadXML(getTheFile);
		var root = xmlDoc.documentElement;
		var thirdLevel = root.childNodes[1].childNodes;
		var div = document.getElementById("elementArea");
		var elStuff = "<ul>";
		for(var i = 1; i < thirdLevel.length; i = i+2){
			elStuff += "<li>" + thirdLevel[i].nodeName + "</li>";
		}
		elStuff += "</ul>";
		div.removeChild(div.firstChild);
		div.innerHTML+= elStuff;
		return null;
	}
	
	function showXML(){

		//get and load xml and xsl files
		var getTheFile = document.getElementById("thirdFile").value;		
		var xmlDoc = loadXML(getTheFile);	
		var stylesheet = loadXML("exercise1.xsl");
		
		//retrieve xpath predicate of return table desired		
		var predicate = document.getElementById("predicate").value;
		
		var sorter = document.getElementById("sortBy").value;
		var orderer = document.getElementById("orderBy").value;
		
		if(orderer == "" || orderer == null){
			orderer == "ascending";
		}
		
		if(sorter == "" || sorter == null){
			sorter == "year";
		}
		
		var columns = "*";
		var defaultHeader = "*[1]/";
		var standInHeader = "*[1]/";
		
		var columnOrder = document.getElementById('columnOrder').value;
		
		if(columnOrder!= null && columnOrder!= ""){
			var columnOrderer = columnOrder.split(" ");
			columns = ""
			for(var i = 0; i < columnOrderer.length; i++){
				columns+=columnOrderer[i];
				defaultHeader+=columnOrderer[i];
				if(i!=columnOrderer.length-1){
					columns+=" | ";
					defaultHeader+= " | " + standInHeader;
				}
			}
		}
	
		var defaultPredicate = "*";
		
		
		var columnNumber = stylesheet.getElementsByTagName("tr");
		var columnHeader = stylesheet.getElementsByTagName("xsl:for-each");
		
		//concatenate xpath predicate
		if(predicate !="" && predicate !=null){
			defaultPredicate += "[" + predicate + "]";
		} 
	   
		var table = stylesheet.getElementsByTagName("table");
		
		//Checks if Firefox
		if (document.implementation && document.implementation.createDocument){
			//removing namespaces
  			var nsResolver = stylesheet.createNSResolver(
                   stylesheet.ownerDocument == null ?
                   stylesheet.documentElement :
                   stylesheet.ownerDocument.documentElement);
				   
				   //evaluating stylesheet
 		 	var value = stylesheet.evaluate(
                   "//xsl:sort",
                   stylesheet, nsResolver,
                   XPathResult.ANY_UNORDERED_NODE_TYPE, null);
				if(sorter!= ""){   
			value.singleNodeValue.setAttribute("select", sorter);
				} 
				if(orderer!= ""){  
			value.singleNodeValue.setAttribute("order", orderer);
				}
				
			//if the user chose a timespan
			if(defaultPredicate !="*"){
				var selector = table[0].childNodes;
				selector[3].setAttribute("select", defaultPredicate);
			}
			
			if(defaultHeader!="*[1]/"){
				var tablaHeader = columnHeader[0];
				tablaHeader.setAttribute("select", defaultHeader);
			}
			
		  var columnFormer = columnNumber[0].firstElementChild;
		  
		  if(columns != "*"){
			  columnFormer.setAttribute("select", columns);
		  }
			  
		  var proc = new XSLTProcessor();
		  proc.importStylesheet(stylesheet);
		  
		  var resultFragment = proc.transformToFragment(xmlDoc, document);
		  //document.write(columns);
		  document.getElementById("tableArea").appendChild(resultFragment);
		  
		 //if using Windows 
		}
	return false;
	}
		
</script>
</head>

<body>
<h2> <strong> Charlie Brodie's IWT Coursework #1</strong></h2>
<br />
<br />
<br />
<div id="thirdLevel">
What File would you like to see the third level Elements of?
<br />
<br />
	<form>
    	<input id="thirdFile" type="text" />
    <input type="button" value="Show me the Elements!" onclick="getThirdLevel()"/>
    </form>
</div>
<br />
<br />
<div id="elementArea">
</div>
<br />
<br />
<div id="getFile">
  <form>
    XPath Predicate:   
    <input id="predicate" type="text">	
    </input>
    <br />
    <br />
    Sort By:	
    <select id="sortBy">
    	<option class="blank"/>
    	<option value="year">Year</option>
        <option value="author">Author</option>
        <option value="title">Title</option>
   	</select>
    Order By:
    <select id="orderBy">
    	<option class="blank"/>
        <option value="ascending">Ascending</option>
        <option value="descending">Descending</option>
       </select>
    <br />
    <br />
    What order would you like? (Separate selections by spaces) 
    <input id="columnOrder" type="text">   
    <br />
    <br />
    <br />
    <input type="button" value="Get Those Results!" onclick="showXML()"/>
  </form>  
</div>  
<br />
<br />
<br />
<div id="tableArea"> </div>
</body>
</html>